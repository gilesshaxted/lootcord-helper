const { SlashCommandBuilder, ActionRowBuilder, StringSelectMenuBuilder, ButtonBuilder, ButtonStyle, ChannelType, MessageFlags } = require('discord.js');
const { createChannelPaginationMessage } = require('../utils/pagination'); // Import pagination utility

// Define how many channels to show per page in the dropdown
const CHANNELS_PER_PAGE = 25; // Max options for StringSelectMenuBuilder

module.exports = {
    // Defines the slash command's name and description.
    data: new SlashCommandBuilder()
        .setName('channel-set')
        .setDescription('Opens a paginated menu to select multiple channels from a specific category.'),

    async execute(interaction, db, client) {
        // NOTE: interaction is already deferred globally in index.js. 

        const guild = interaction.guild;

        if (!guild) {
            // Use followUp for errors since deferral already occurred
            return await interaction.followUp({ content: 'This command can only be used in a guild.', flags: MessageFlags.Ephemeral });
        }
        
        // Use the centralized utility function to create the initial (Page 0) message components.
        // CRITICAL: We pass the 'db' reference here so the pagination helper can fetch existing configs.
        const { content, components } = await createChannelPaginationMessage(guild, 0, db);

        // Handle case where no channels are found 
        if (components.length === 0) {
            return await interaction.editReply({ 
                content: content,
                flags: MessageFlags.Ephemeral
            });
        }
        
        // Send the message with the dropdown and buttons using editReply
        await interaction.editReply({
            content: content,
            components: components, // Components are the two ActionRows generated by the utility
            flags: MessageFlags.Ephemeral
        });
    },
};
